# Pelican Wings Installation Guide for TrueNAS Scale

This guide details how to configure Pelican Wings on TrueNAS Scale using Docker Compose, solving common bind mount issues.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Directory Structure](#directory-structure)
3. [Dataset Creation and Directory Setup](#dataset-creation-and-directory-setup)
4. [Docker Compose Configuration](#docker-compose-configuration)
5. [Common Issue: Bind Mounts](#common-issue-bind-mounts)
6. [Deployment](#deployment)
7. [Verification](#verification)
8. [Troubleshooting](#troubleshooting)

---

## Prerequisites

- TrueNAS Scale server
- SSH access to the server
- Pelican Panel installed and running
- Node created in the panel (to get UUID, token_id and token)

---

## Directory Structure

Wings requires the following directories on the host:

```
[mnt]
└── <your-pool>
    └── <your-Dataset>/            # ZFS Dataset (CREATE IN TRUENAS UI)
        └── wings/
            ├── varlib/        # Wings persistent data
            │   └── volumes/   # Game server volumes (CRITICAL)
            ├── logs/          # Wings logs
            └── etc/           # Wings configuration

/tmp/pelican/                  # Temporary directory for installations (CRITICAL)
```

### Directory Description

| Directory | Purpose | Persistence |
|-----------|---------|-------------|
| `varlib/` | Wings internal data | Persistent |
| `varlib/volumes/` | Files for each game server | Persistent |
| `logs/` | Wings logs | Persistent |
| `etc/` | Configuration | Persistent |
| `/tmp/pelican/` | Temporary installation scripts | Temporary (cleared on reboot) |

---

## Dataset Creation and Directory Setup

### Step 1: Create Dataset in TrueNAS SCALE UI

1. Go to **Datasets**
2. Select your pool (e.g., `Discos3tb`)
3. Click **Add Dataset**
4. Name: `<your-Dataset>`
5. Recommended settings:
   - Compression: `lz4`
   - Enable atime: `Off`
   - Share type: `Unix` or `Generic`
6. Click **Save**

### Step 2: Create directories via SSH

```bash
# Create structure inside the dataset
mkdir -p /mnt/<your-pool>/<your-Dataset>/wings/varlib/volumes
mkdir -p /mnt/<your-pool>/<your-Dataset>/wings/logs
mkdir -p /mnt/<your-pool>/<your-Dataset>/wings/etc

# Create temporary directory (CRITICAL for installations)
mkdir -p /tmp/pelican

# Verify creation
ls -la /mnt/<your-pool>/<your-Dataset>/wings/
ls -la /tmp/pelican
```

### Permissions (if needed)

```bash
# If you have permission issues
chmod -R 755 /mnt/<your-pool>/<your-Dataset>/wings/
chmod -R 755 /tmp/pelican
```

---

## Docker Compose Configuration

Create the `wing.yml` file with the following structure:

```yaml
configs:
  wings_config:
    content: |
      debug: false
      uuid: <NODE-UUID>
      token_id: <TOKEN-ID>
      token: <TOKEN>
      api:
        host: 0.0.0.0
        port: 8080
        ssl:
          enabled: false
          cert: /etc/letsencrypt/live/<your-domain>/fullchain.pem
          key: /etc/letsencrypt/live/<your-domain>/privkey.pem
        upload_limit: 256
      system:
        data: /mnt/<your-pool>/<your-Dataset>/wings/varlib/volumes
        sftp:
          bind_port: 2022
      allowed_mounts: []
      remote: "http://<PANEL-IP>:<PORT>"

networks:
  wings0:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: wings0
    ipam:
      config:
        - subnet: 172.21.0.0/16
    name: wings0

services:
  wings:
    configs:
      - source: wings_config
        target: /etc/pelican/config.yml
    container_name: pelican_wings
    environment:
      TZ: Europe/Madrid
      WINGS_GID: 0
      WINGS_UID: 0
      WINGS_USERNAME: pelican
    image: ghcr.io/pelican-dev/wings:latest
    networks:
      - wings0
    ports:
      - '8080:8080'
      - '2022:2022'
    restart: always
    tty: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /mnt/<your-pool>/<your-Dataset>/wings/varlib:/var/lib/pelican
      - /mnt/<your-pool>/<your-Dataset>/wings/logs:/var/log/pelican
      - /mnt/<your-pool>/<your-Dataset>/wings/etc:/etc/pelican
      - /etc/ssl/certs:/etc/ssl/certs:ro
      # Path-through mounts: CRITICAL - Wings uses these exact paths when creating containers
      - /mnt/<your-pool>/<your-Dataset>/wings/varlib/volumes:/mnt/<your-pool>/<your-Dataset>/wings/varlib/volumes
      - /tmp/pelican:/tmp/pelican

version: '3.9'
```

### Variables to Replace

| Variable | Description | Example |
|----------|-------------|---------|
| `<your-pool>` | Your storage pool name | `Discos3tb` |
| `<your-Dataset>` | Your dataset name | `Pelicanweb` |
| `<NODE-UUID>` | UUID generated by panel when creating node | `f587d2ed-c2ef-...` |
| `<TOKEN-ID>` | Authentication token ID | `IzH4545s45dPJ` |
| `<TOKEN>` | Authentication token | (long string) |
| `<PANEL-IP>` | IP where Pelican panel runs | `192.168.1.140` |
| `<PORT>` | Panel port | `8088` |
| `<your-domain>` | Domain for SSL (if using HTTPS) | `panel.example.com` |

---

## Common Issue: Bind Mounts

### The Problem

When Wings runs in a Docker container and creates game servers, the following happens:

1. Wings creates directories inside the container (e.g., `/tmp/pelican/UUID/`)
2. Wings then creates server containers that mount those directories
3. Docker looks for those paths on the **HOST**, not inside the Wings container
4. If the path doesn't exist on the host → **ERROR: bind source path does not exist**

### The Solution: Path-Through Mounts

**Path-through mounts** map the same path inside and outside the container:

```yaml
# ❌ INCORRECT - Wings sees /tmp/pelican, but host has different path
- /mnt/pool/tmp:/tmp/pelican

# ✅ CORRECT - Same path exists in both places
- /tmp/pelican:/tmp/pelican
- /mnt/pool/wings/varlib/volumes:/mnt/pool/wings/varlib/volumes
```

### Why It Works

```
Wings Container                    Host (TrueNAS)
─────────────────                  ───────────────
/tmp/pelican/UUID/    ←────────→   /tmp/pelican/UUID/
       │                                  │
       └── Wings creates here    Docker finds here ──┘
```

---

## Deployment

### Step 1: Create directories

```bash
mkdir -p /mnt/<your-pool>/<your-Dataset>/wings/varlib/volumes
mkdir -p /mnt/<your-pool>/<your-Dataset>/wings/logs
mkdir -p /mnt/<your-pool>/<your-Dataset>/wings/etc
mkdir -p /tmp/pelican
```

### Step 2: Import application in TrueNAS Scale

1. Go to **Applications** in TrueNAS main menu
2. Click the blue **"Discover Applications"** button
3. In the new tab, look in the top right corner for the **"Custom App"** button
4. Click the **3 dots (...)** next to "Custom App"
5. Select **"Install via YAML"**
6. Paste the complete content of your `wing.yml` file
7. Click **"Install"**

### Step 3: Verify deployment
To verify that everything is correct, you need to go to Portainer and check your container log.


---

## Verification

### Check from panel

1. Go to **Admin → Nodes** in Pelican panel
2. Node should show "Connected" status (green)

---

## Troubleshooting

### Error: "bind source path does not exist"

**Cause**: Missing path-through mount or directory doesn't exist on host.

**Solution**:
1. Identify which path is missing in the error
2. Create directory on host: `mkdir -p /missing/path`
3. Ensure you have the path-through mount in `wing.yml`
4. Recreate container: `docker compose -f wing.yml down && docker compose -f wing.yml up -d`

### Error: "connection refused" to panel

**Cause**: Wings cannot connect to panel.

**Solution**:
1. Verify URL in `remote:` is correct
2. Ensure panel is accessible from TrueNAS
3. Check firewalls/ports

### Servers won't start

**Cause**: Permission or network issues.

**Solution**:
1. Check that `wings0` network exists: `docker network ls | grep wings0`
2. Review directory permissions
3. Check logs: `docker logs pelican_wings`

### /tmp/pelican gets cleared on reboot

**Note**: This is normal. `/tmp` directory is cleared on reboots. Just recreate it:

```bash
mkdir -p /tmp/pelican
```

You can add this to a startup script or create a `@reboot` cronjob.

---

## Port Summary

| Port | Service | Description |
|------|---------|-------------|
| 8080 | Wings API | Communication with panel |
| 2022 | SFTP | Server file access |

---

## Additional Notes

- **SSL**: If using SSL, ensure certificates are accessible and set `ssl.enabled: true`
- **Timezone**: Adjust `TZ` according to your location
- **Network**: Subnet `172.21.0.0/16` can be changed if there are conflicts

---

*Documentation created for Pelican Panel + Wings on TrueNAS Scale*
